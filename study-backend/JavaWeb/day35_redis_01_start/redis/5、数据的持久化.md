**1、数据的持久化**

- 快照的生成方式(dump.rdb文件)

  - 客户端生成方式
    - ``bgsave``：（推荐）客户端可以使用BGSAVE命令来创建一一个快照， 当接收到客户端的BGSAVE命令时，redis会调用fork来创建一个子进程 ,然后子进程负责将快照写入磁盘中,而父进程则继续处理命令请求。

    - ``save``：客户端还可以使用SAVE命令来创建一个快照,接收到SAVE命令的redis服务器在快照创建完毕之前将不再响应任何其他的命令

  - 服务器自动化触发生成

    - 如果用户在redis.conf中设置了save配置选项, redis会在save选项条件满足之后自动触发一次BGSAVE命令 ,如果设置多个save配置选项,当任意一个save配置 选项条件满足, redis也会触发一次BGSAVE命令

- AOF （append only file）将所有写命令日志记录到日志文件中

  - 这种方式可以将所有客户端执行的写命令记录到日志文件中，AOF持久化会将被执行的写命令写到AOF的文件末尾,以此来记录数据发生的变化，因此只要redis从头到尾执行一次AOF文件所包含的所有 写命令,就可以恢复AOF文件的记录的数据集.

    - ``appendonly no ->yes``开启AOF
    - ``appendfsync everysec``（推荐）每秒保存一次aof 要想保存aof日志 需要开启appendfsync
    - ``appendfsync aways``同步保存aof
    - ``appendfsync no``由操作系统决定何时保存aof

  - AOF带来的问题：AOF的方式也同时带来了另-个问题。持久化文件会变的越来越大。例如我们调用incr test命令100次，文件中必须保存全部的100条命令，其实有99条都是多余的。因为要恢复数据库的状态其实文件中保存一条set test 100就够了。为了压缩aof的持久化文件Redis提供了AOF重写(ReWriter)机制。

  - 触发重写方式

    - 客户端触发重写

      ``BGREWRITEAOF``不会阻塞redis服务

    - 服务器配置方式自动触发

      ``auto-aof-rewrite-percentage 100``

      ``auto-aof-rewrite-min-size 64m``

      如果设置auto-aof-rewrite-percentage值为100和auto-aof-rewrite-min-size 64mb, 并且启用的AOF持久化时,那么当AOF文件体积大于64M,并且AOF文件的体积比上一次重写之后体积大了至少一倍(100%)时，会自动触发,如果重写过于频繁,用户可以考虑将auto-aof-rewrite-percentage设置为更大

      注意:重写aof文件的操作，并没有读取旧的aof文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的aof文件,替换原有的文件这点和快照有点类似。