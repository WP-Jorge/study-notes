<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>
	<body>
		<script>
			let obj = {
				type: '对象',
				user: {
					name: '张三',
					parent: ['李四', '王五']
				},
				childs: ['赵六', '宋七'],
				null: null,
				undefined: undefined,
				regexp: /123/,
				date: new Date(),
				func: function(a, b, c) {
					console.log('函数');
				}
			};
			obj.obj = obj;
			function deepCopy(obj, map = new WeakMap()) {
				// 1、判断 obj 的类型，如果是对象，则进入内部进行处理
				if (typeof obj === 'object') {
					// 2、如果是 null。就直接返回 null
					if (obj === null) {
						return null;
					}
					// 3、判断对象是数组还是对象，并创建相应容器
					let res = Array.isArray(obj) ? [] : {};
					// 4、处理循环引用
					if (map.has(obj)) {
						return map.get(obj);
					}
					map.set(obj, res);
					// 5、如果是数组，循环深克隆这个数组
					if (obj instanceof Array) {
						obj.forEach((item, index) => {
							res.push(deepCopy(item, map));
						});
						return res;
					}
					// 6、如果是对象，进入对象的内部处理
					if (obj instanceof Object) {
						// 7、在这里可以处理其他不能遍历的对象，这边举例 Date、RegExp
						if (obj instanceof Date) {
							return new obj.constructor(obj);
						}
						if (obj instanceof RegExp) {
							let reFlags = /\w*$/;
							res = new obj.constructor(obj.source, reFlags.exec(obj));
							res.lastIndex = obj.lastIndex;
							return res;
						}
						// 8、如果是普通对象，则深克隆这个对象
						for (let key in obj) {
							if (obj.hasOwnProperty(key)) {
								res[key] = deepCopy(obj[key], map);
							}
						}
						return res;
					}
				}
				// 9、如果是函数，则使用正则提取出函数参数与函数体
				if (obj instanceof Function) {
					let paramReg = /(?<=\().+(?=\)\s+{)/;
					let bodyReg = /(?<={)(.|\n)+(?=})/m;
					let funcString = obj.toString();
					if (obj.prototype) {
						let param = paramReg.exec(funcString);
						let body = bodyReg.exec(funcString);
						if (body) {
							if (param) {
								let paramArr = param[0].split(',');
								return new Function(...paramArr, body[0]);
							}
							return new Function(body[0]);
						}
						return null;
					}
					return eval(funcString);
				}
				return obj;
			}
			let newObj = deepCopy(obj);
			console.log(newObj); // {type: '对象', user: {…}, childs: Array(2)}
			newObj.childs.push('王八');
			console.log(newObj); // {type: '对象', user: {…}, childs: Array(3)}
			console.log(obj); // {type: '对象', user: {…}, childs: Array(2)}
			console.log(obj, newObj);
		</script>
	</body>
</html>
