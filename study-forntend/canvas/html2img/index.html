<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<style>
			.card {
				display: none;
				background-color: white;
				margin: 2em;
				box-shadow: 0 0 1em rgba(0, 0, 0, 0.2);
				border-radius: 0.5em;
				width: 400px;
			}

			.cover {
				width: 180px;
			}

			.cover img {
				display: block;
				max-width: 100%;
				height: 100%;
				border-radius: 0.5em 0 0 0.5em;
			}

			.text {
				flex: 1;
				text-align: center;
				padding-top: 2em;
			}

			.text h1 {
				font-size: 1em;
			}
		</style>
	</head>
	<body>
		<svg width="0" height="0" viewBox="0 0 470 320">
			<!-- <svg width="470" height="320" viewBox="0 0 470 320"> -->
			<foreignObject width="100%" height="100%">
				<div xmlns="http://www.w3.org/1999/xhtml">
					<div class="card">
						<div class="cover">
							<img src="./libai.jpeg" />
						</div>
						<div class="text">
							<h1>é™å¤œæ€</h1>
							<p>åºŠå‰çœ‹æœˆå…‰</p>
							<p>ç–‘æ˜¯åœ°ä¸Šéœœ</p>
							<p>æŠ¬å¤´æœ›å±±æœˆ</p>
							<p>ä½å¤´æ€æ•…ä¹¡</p>
						</div>
					</div>
				</div>
			</foreignObject>
		</svg>
		<button>ç”Ÿæˆå›¾ç‰‡</button>
		<script>
			const displayStr = `.card {display: flex;}`;

			// å°† url å¼‚æ­¥è½¬æ¢æˆ base64 æ ¼å¼
			function getImgBase64(url) {
				return new Promise(resolve => {
					const img = new Image();
					img.crossOrigin = 'Anonymous';
					img.src = url;
					img.onload = function () {
						resolve(image2Base64(img));
					};
				});
			}

			// å°† img è½¬æ¢æˆ base64 æ ¼å¼
			function image2Base64(img) {
				const canvas = document.createElement('canvas');
				const ctx = canvas.getContext('2d');
				canvas.width = img.width;
				canvas.height = img.height;
				ctx.drawImage(img, 0, 0);
				return (dataURL = canvas.toDataURL());
			}

			// å°† svg ä¸­çš„ img è½¬æ¢æˆ base64 æ ¼å¼
			async function sImg2tImg(sImgs, tImgs) {
				for (let i = 0; i < tImgs.length; i++) {
					const base64Url = await getImgBase64(sImgs[i].src);
					sImgs[i].src = base64Url;
				}
			}

			// ä¸‹è½½å›¾ç‰‡
			async function download() {
				const img = new Image();
				const svg = document.querySelector('svg').cloneNode(true);
				svg.setAttribute('width', 470);
				svg.setAttribute('height', 320);
				console.dir(svg);

				console.dir(document.querySelector('style'));

				// æŠŠ style æ ‡ç­¾ä¸­çš„ CSS ä»£ç å¼•å…¥ SVG å›¾ç‰‡ä¸­
				const styleNode = document
					.querySelector('style')
					.cloneNode(true);
				styleNode.textContent += displayStr;
				svg.querySelector('foreignObject').before(styleNode);

				// è½¬æ¢ HTML ä»£ç ä¸­çš„å›¾ç‰‡åœ°å€
				const sImgs = svg.querySelectorAll('img');
				const tImgs = document.querySelectorAll('svg img');
				await sImg2tImg(sImgs, tImgs);

				// è®¾ç½® HTML è½¬ SVG åçš„å›¾ç‰‡å†…å®¹æ ¼å¼
				img.src =
					'data:image/svg+xml;charset=utf-8,' +
					new XMLSerializer().serializeToString(svg);

				console.log('ğŸ¦ƒğŸ¦ƒimg.src', img.src);

				// ç­‰å¾… img å¯¹è±¡å®Œæˆå›¾ç‰‡çš„æ¸²æŸ“åŠ è½½åæ‰§è¡Œä¸‹è½½
				img.onload = function () {
					const a = document.createElement('a');
					a.download = 'image.png';
					a.href = image2Base64(img);
					a.click();
				};
			}

			// ç‚¹å‡»æŒ‰é’®æ—¶ç”Ÿæˆå›¾ç‰‡å¹¶ä¸‹è½½
			document
				.querySelector('button')
				.addEventListener('click', download);
		</script>
	</body>
</html>
